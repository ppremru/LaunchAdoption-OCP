# Step 3: Registry Setup (Disconnected)

Created Date: January 14, 2026

Status: Ingestion Phase

This document guides the administrator through setting up the local mirror registry on the **Disconnected Bastion** and performing the **Ingestion** phase of the Sneakernet process. This registry will serve as the single source of truth for the SNO node.

## Local Registry Overview

| Task | Description |
| --- | --- |
| Mirror Registry Installation | Deploying the `mirror-registry` tool (Quay) onto the Disconnected Bastion to host container images. |
| Trust Establishment | Configuring the Disconnected Bastion and future SNO node to trust the local registry's self-signed or internal CA certificate. |
| Content Ingestion | Uploading the mirrored image set from physical media into the local registry using `oc-mirror`. |

### Registry Configuration Reference Script

> **Note**: The following commands represent a **baseline implementation** for a local Quay registry. Ensure your physical media is mounted to the Disconnected Bastion before starting.

```bash
# 1. Install the Mirror Registry (Quay)
# Ensure the mirror-registry.tar.gz is extracted
./mirror-registry install --unattended \
                          --targetHostname <registry_fqdn> \
                          --targetAddr <registry_ip>

# 2. Add Registry CA to Trusted Bundle
# This ensures oc-mirror can authenticate without TLS errors
sudo cp /etc/pki/ca-trust/source/anchors/local-registry.crt /etc/pki/ca-trust/source/anchors/
sudo update-ca-trust

# 3. Perform the Ingestion (Media to Registry)
# Replace <path_to_media> with your mount point
oc-mirror --from file://<path_to_media>/mirror-data \
          docker://<registry_fqdn>:8443 \
          --workspace file://./workspace

```

---

## Technical Process & Justifications

| Category | Justification |
| --- | --- |
| Unattended Install | Using the `--unattended` flag ensures a consistent deployment and automatically generates the `quay-install.log` for troubleshooting. |
| Port 8443 | By default, the `mirror-registry` tool uses port 8443 for HTTPS traffic; ensure this port is open in the local firewall. |
| Workspace Sync | You must use the same `workspace` folder (or metadata) that was generated during the **Collection** phase to ensure successful ingestion. |

---

## Architectural Justifications & Reference Notes

| Category | Technical Requirement Details | Documentation Source |
| --- | --- | --- |
| Internal DNS | The `<registry_fqdn>` used during installation must be resolvable by both the Disconnected Bastion and the Target SNO Node. | [Installing on a single node](https://docs.redhat.com/en/documentation/openshift_container_platform/4.16/html/installing_on_a_single_node/index) |
| Pull Secret Merge | After the ingestion, `oc-mirror` generates a new `pull-secret.json`. This **must** be merged with your original Red Hat pull secret to allow the SNO node to pull from the local registry. | [oc-mirror Documentation](https://docs.redhat.com/en/documentation/openshift_container_platform/4.16/html/disconnected_installation_mirroring/installing-mirroring-disconnected) |
| Persistent Storage | The registry data is stored in `/var/lib/quay` by default. Ensure this directory is backed by sufficient persistent storage (minimum 200GB). | [Creating a mirror registry](https://www.google.com/search?q=https://docs.redhat.com/en/documentation/openshift_container_platform/4.16/html/disconnected_installation_mirroring/installing-mirroring-creating-mirror-registry) |

---

# Step 3 Appendix: Certificate Hardening for Production

In many enterprise and government environments, using the default self-signed certificates generated by the `mirror-registry` tool does not meet security compliance standards (such as Zero Trust or FIPS-validated communications). This section provides the steps to replace self-signed certificates with those issued by your organization's internal Certificate Authority (CA).

## Comparison: Self-Signed vs. Enterprise CA

| Feature | Self-Signed (Default) | Enterprise CA (Hardened) |
| --- | --- | --- |
| Trust Source | The registry itself acts as the CA. | A central, managed Internal Root CA. |
| Management | Manual; each host must be updated. | Scalable; the Root CA is pre-trusted by the OS. |
| Compliance | Usually fails Audit/Compliance scans. | Meets standard government/enterprise requirements. |

---

## Hardening Process: Implementing Internal CA Certificates

> **Note**: These steps should be performed on the **Disconnected Bastion** after the initial registry installation but before the SNO node is deployed.

### 1. Request the Certificate

Generate a Certificate Signing Request (CSR) for your registry's FQDN and have it signed by your Internal CA. You will need:

* `domain.crt`: The certificate signed by your CA.
* `domain.key`: The private key used to generate the CSR.
* `rootCA.crt`: The public Root CA certificate.

### 2. Update the Mirror Registry

Replace the default certificates in the Quay configuration directory (typically `/opt/quay/config`).

```bash
# Backup existing certificates
sudo cp /opt/quay/config/ssl.crt /opt/quay/config/ssl.crt.bak
sudo cp /opt/quay/config/ssl.key /opt/quay/config/ssl.key.bak

# Deploy new Enterprise CA certificates
# Ensure your domain.crt includes the full certificate chain
sudo cp ./domain.crt /opt/quay/config/ssl.crt
sudo cp ./domain.key /opt/quay/config/ssl.key

# Restart the registry to apply changes
sudo systemctl restart quay-app

```

### 3. Inject the Root CA into OpenShift

For the SNO node to trust the registry, you must include the **Root CA** in your `install-config.yaml`.

```yaml
# Add to your install-config.yaml
additionalTrustBundle: |
  -----BEGIN CERTIFICATE-----
  <Content of your rootCA.crt>
  -----END CERTIFICATE-----

```

---

## Architectural Justifications & Reference Notes

| Category | Technical Requirement Details | Documentation Source |
| --- | --- | --- |
| Chain of Trust | If your CA uses intermediate certificates, the `ssl.crt` file must contain the registry certificate followed by all intermediate certificates in order. | [Configuring Quay with custom certificates](https://www.google.com/search?q=https://docs.redhat.com/en/documentation/red_hat_quay/3/html/deploying_red_hat_quay_on_openshift_container_platform/index) |
| Trust Bundle | The `additionalTrustBundle` in the `install-config.yaml` is the primary mechanism for injecting custom CA certificates into the RHCOS operating system at boot time. | [Mirroring images for disconnected installation](https://docs.redhat.com/en/documentation/openshift_container_platform/4.16/html/disconnected_installation_mirroring/index) |
| SAN Requirements | Ensure the certificate's Subject Alternative Name (SAN) includes both the FQDN and the IP address of the Disconnected Bastion to avoid "Name Mismatch" errors during the pull. | [Registry certificate requirements](https://docs.redhat.com/en/documentation/openshift_container_platform/4.16/html/installing_on_a_single_node/index) |

---


